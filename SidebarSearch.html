<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    <!-- Title: <input type="text" id="title-input" data-column-name="title" class="search-bar" autocomplete="off" placeholder="War And Peace"> -->
    <!-- <br> -->
    <!-- Everything: <input type="text" id="everything-input" data-column-name="everything" class="search-bar" autocomplete="off" placeholder="Title, Author, etc."> -->
    <!-- <br> -->
    <div id="search-fields"></div>
    <input type="button" value="Search" id="search-submit">
    <hr>
    <input type="submit" value="Clear" id="clear-button"/>
    <input type="button" value="Close" id="close-button"/>
  </body>
  <script>
  (function() {
    const DOM = {};
    DOM.searchFieldsDiv = document.querySelector("#search-fields");
    // DOM.titleInput = document.querySelector("#title-input");

    const ALL_COLUMNS = [ "title", "author", "description", "everything"]

    ALL_COLUMNS.forEach(function(column){
      addSearchField(column);
    })

    DOM.searchSubmit = document.querySelector("#search-submit");

    DOM.searchFields =  document.querySelectorAll(".search-field");

    DOM.clearButton = document.querySelector("#clear-button");
    DOM.closeButton = document.querySelector("#close-button");

    function submitSearch(e){
      e.preventDefault();
      const allColumns = ["isbn", "title", "description"]
      const searchPairs = {}
      // TODO: refactor all this
      DOM.searchFields.forEach(function(searchBar) {
        const searchTerm = searchBar.value.trim();
        if(searchTerm.length){
          let columnNames = [searchBar.dataset.columnName];
          if(columnNames[0] == "everything"){
            columnNames = allColumns
          }
          columnNames.forEach(function(columnName){
            if(searchPairs[columnName]){
              searchPairs[columnName].push(searchTerm)
            }
            else {
              searchPairs[columnName] = [searchTerm]
            }
          })
        }
      })
      const searchGroups = Object.keys(searchPairs).map(function(key) {
        return {
          column: key,
          searchTerms: searchPairs[key]
        }
      });
      // alert(JSON.stringify(searchGroups, null, 2))
      google.script.run.sidebarSearch(searchGroups)
    }

    function clearSearch(){
      google.script.run.clearSearchFilter();
      DOM.searchBars.forEach(function(searchBar) {
        searchBar.value = "";
      })
    }

    function closeSidebar () {



      google.script.host.close();
    }

    // From: https://stackoverflow.com/a/1026087
    // Steve Harrison: https://stackoverflow.com/users/48492/steve-harrison
    function capitalize(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function addSearchField(name){
      // Title: <input type="text" id="title-input"
      // data-column-name="title" class="search-field"
      // autocomplete="off">

      const fieldInput = document.createElement("input");

      const inputAttributes = []

      const inputType = document.createAttribute("type")
      inputType.value = "text";
      inputAttributes.push(inputType)

      const inputClass = document.createAttribute("class")
      inputClass.value = `search-field`;
      inputAttributes.push(inputClass)

      const inputAutocomplete = document.createAttribute("autocomplete")
      inputAutocomplete.value = `off`;
      inputAttributes.push(inputAutocomplete)

      inputAttributes.forEach(function(attribute){
        fieldInput.setAttributeNode(attribute);
      })

      const newFieldDiv = document.createElement("div");
      const fieldName = document.createTextNode(`${capitalize(name)}: `);

      newFieldDiv.appendChild(fieldName);
      newFieldDiv.appendChild(fieldInput);

      DOM.searchFieldsDiv.appendChild(newFieldDiv)
    }

    DOM.searchFields.forEach(function(searchField) {
      searchField.addEventListener("keyup", function(e){
        if (e.keyCode === 13) {
          submitSearch(e);
        }
      });
    })

    DOM.searchSubmit.addEventListener("click", submitSearch);
    DOM.clearButton.addEventListener("click", clearSearch);
    DOM.closeButton.addEventListener("click", closeSidebar);
  })();
  </script>
</html>
