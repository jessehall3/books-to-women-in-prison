<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    <div id="search-fields"></div>
    <input type="button" value="Search" id="search-submit">
    <hr>
    <input type="submit" value="Clear" id="clear-button"/>
    <input type="button" value="Close" id="close-button"/>
  </body>
  <script>
  (function() {
    const DOM = {};
    DOM.searchFieldsDiv = document.querySelector("#search-fields");
    DOM.searchSubmit = document.querySelector("#search-submit");
    DOM.clearButton = document.querySelector("#clear-button");
    DOM.closeButton = document.querySelector("#close-button");

    const searchFieldClass = ".search-field"

    function submitSearch(e){
      e.preventDefault();
      const allColumns = ["isbn", "title", "description"]
      const searchPairs = {}
      // TODO: refactor all this
      const searchFields = document.querySelectorAll(searchFieldClass)
      searchFields.forEach(function(searchField) {
        const searchTerm = searchField.value.trim();
        if(searchTerm.length){
          let columnNames = [searchField.dataset.columnName];
          if(columnNames[0] == "everything"){
            columnNames = allColumns
          }
          columnNames.forEach(function(columnName){
            if(searchPairs[columnName]){
              searchPairs[columnName].push(searchTerm)
            }
            else {
              searchPairs[columnName] = [searchTerm]
            }
          })
        }
      })
      const searchGroups = Object.keys(searchPairs).map(function(key) {
        return {
          column: key,
          searchTerms: searchPairs[key]
        }
      });
      // alert(JSON.stringify(searchGroups, null, 2))
      google.script.run.sidebarSearch(searchGroups)
    }

    function clearSearch(){
      google.script.run.clearSearchFilter();
      const searchFields = document.querySelectorAll(searchFieldClass)
      searchFields.forEach(function(searchField) {
        searchField.value = "";
      })
    }

    function closeSidebar () {
      clearSearch();
      google.script.host.close();
    }

    // From: https://stackoverflow.com/a/1026087
    // Steve Harrison: https://stackoverflow.com/users/48492/steve-harrison
    function capitalize(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function addSearchField(fieldName){
      // Title: <input type="text" id="title-input"
      // data-column-name="title" class="search-field"
      // autocomplete="off">

      const fieldInput = document.createElement("input");

      const inputAttributes = []

      const inputType = document.createAttribute("type")
      inputType.value = "text";
      inputAttributes.push(inputType)

      const inputClass = document.createAttribute("class")
      inputClass.value = `search-field`;
      inputAttributes.push(inputClass)

      fieldInput.setAttribute("data-column-name", fieldName)

      const inputAutocomplete = document.createAttribute("autocomplete")
      inputAutocomplete.value = `off`;
      inputAttributes.push(inputAutocomplete)

      inputAttributes.forEach(function(attribute){
        fieldInput.setAttributeNode(attribute);
      })

      const newFieldDiv = document.createElement("div");
      const fieldLabel = document.createTextNode(`${capitalize(fieldName)}: `);

      newFieldDiv.appendChild(fieldLabel);
      newFieldDiv.appendChild(fieldInput);

      DOM.searchFieldsDiv.appendChild(newFieldDiv)
    }

    function addSearchFields(fields){
      fields.forEach(function(column){
        addSearchField(column);

        searchFieldDivs =  document.querySelectorAll(".search-field");

        searchFieldDivs.forEach(function(searchField) {
          searchField.addEventListener("keyup", function(e){
            if (e.keyCode === 13) {
              submitSearch(e);
            }
          });
        })
      })
    }

    function init(){
      const FIELDS = [ "title", "author", "description", "everything"]
      addSearchFields(FIELDS);

      DOM.searchSubmit.addEventListener("click", submitSearch);
      DOM.clearButton.addEventListener("click", clearSearch);
      DOM.closeButton.addEventListener("click", closeSidebar);
    }

    init();
  })();
  </script>
</html>
